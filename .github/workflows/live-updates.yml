name: Live updates

on:
  workflow_dispatch:

jobs:
  check-live-updates:
    name: Check packages for live updates
    runs-on: ubuntu-22.04
    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.LIVE_UPDATE_APP_ID }}
          private-key: ${{ secrets.LIVE_UPDATE_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: false

      # See: https://github.com/actions/create-github-app-token/tree/a3c826a2042b1cef171cbabedfd93c93623f4061?tab=readme-ov-file#configure-git-cli-for-an-apps-bot-user
      - name: Configure git user
        run: |
          user_id=$(gh api "/users/${app_slug}[bot]" --jq .id)
          git config --global user.name "${app_slug}[bot]"
          git config --global user.email "${user_id}+${app_slug}[bot]@users.noreply.github.com"
        env:
          app_slug: ${{ steps.app-token.outputs.app-slug }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Install Brioche
        run: |
          mkdir -p ~/.local/bin
          curl -L https://development-content.brioche.dev/github.com/brioche-dev/brioche/branches/main/x86_64-linux/brioche -o ~/.local/bin/brioche
          chmod +x ~/.local/bin/brioche
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Update packages
        run: |
          git_head="$(git rev-parse HEAD)"

          for package in packages/*; do
            branch_name="live-update/$(basename "$package")"
            if grep -q 'export.*autoUpdate' "$package/project.bri"; then
              echo "::group::$package"

              git checkout "origin/${branch_name}" || git checkout "${git_head}"
              git clean -ffdx
              brioche live-update -p "$package" --locked

              if [ -n "$(git status --porcelain)" ]; then
                git checkout -b "$branch_name"
                git add "$package"
                git commit -m "[live-update] $package"
                echo "ðŸŸ¢ Updated $package"
              else
                echo "âšª No updates for $package"
              fi

              echo "::endgroup::"
            else
              echo "$package: no live-update found"
            fi
          done

      - name: Configure git credentials
        run: git remote set-url origin "$auth_url"
        env:
          auth_url: https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${{ github.repository }}.git

      - name: Push branches
        run: |
          # git checkout -b build/live-update-test
          # git commit --allow-empty -m 'Live update test'
          # git push origin build/live-update-test
          git for-each-ref --format='%(refname:short)' refs/heads/live-update | while read branch; do
            echo "Pushing $branch"
            echo git push origin "$branch"
          done
