name: Live updates

on:
  workflow_dispatch:
  schedule:
    - cron: "37 5 15 * *" # On the 15th of the month at 5:37am UTC

jobs:
  live-update-packages:
    name: Live-update packages
    runs-on: ubuntu-24.04
    steps:
      - name: Create GitHub app token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.LIVE_UPDATE_APP_ID }}
          private-key: ${{ secrets.LIVE_UPDATE_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: false

      # See: https://github.com/actions/create-github-app-token/tree/a3c826a2042b1cef171cbabedfd93c93623f4061?tab=readme-ov-file#configure-git-cli-for-an-apps-bot-user
      - name: Configure git user
        run: |
          user_id=$(gh api "/users/${app_slug}[bot]" --jq .id)
          git config --global user.name "${app_slug}[bot]"
          git config --global user.email "${user_id}+${app_slug}[bot]@users.noreply.github.com"
        env:
          app_slug: ${{ steps.app-token.outputs.app-slug }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Install Brioche
        uses: brioche-dev/setup-brioche@v1
        with:
          version: "nightly"

      - name: Update packages
        env:
          # Authenticate for GitHub API requests for increased rate limits
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git_head="$(git rev-parse HEAD)"
          packages=(packages/*)
          mapfile -t packages < <(printf '%s\n' "${packages[@]}" | sort -R) # Shuffle the packages
          failed_packages=()

          n=1
          for package in "${packages[@]}"; do
            branch_name="live-update/$(basename "$package")"
            label="$package ($n / ${#packages[@]})"
            ((n++))

            if grep -q 'export.*liveUpdate' "$package/project.bri"; then
              echo "::group::$label"

              if git fetch --depth=1 origin "$branch_name" 2>/dev/null; then
                git checkout -f "origin/${branch_name}" 2>/dev/null
                git clean -ffdx 2>/dev/null

                git fetch --depth=1 origin main 2>/dev/null
                if ! git merge origin/main --no-edit 2>&1 | grep -v "^Already up to date"; then
                  echo "ðŸ”´ Failed to merge main into $branch_name"
                  echo "::error file=$package/project.bri::Failed to merge main into $branch_name"
                  failed_packages+=("$package")
                  git merge --abort 2>/dev/null

                  echo "::endgroup::"
                  continue
                fi
              else
                echo "No existing branch for package $package"
                git checkout -f "${git_head}" 2>/dev/null
                git clean -ffdx 2>/dev/null
              fi

              if ! brioche live-update -p "$package" --locked; then
                echo "ðŸ”´ Failed to update $package"
                echo "::error file=$package/project.bri::Failed to update $package"
                failed_packages+=("$package")

                echo "::endgroup::"
                continue
              fi

              if [ -n "$(git status --porcelain)" ]; then
                git checkout -b "$branch_name" 2>/dev/null
                git add "$package" 2>/dev/null
                git commit -m "[live-update] $package" 2>/dev/null
                echo "ðŸŸ¢ Updated $package"
              else
                echo "âšª No updates for $package"
              fi

              echo "::endgroup::"
            else
              echo "$label: no live-update found"
            fi
          done

          git checkout "$git_head"
          printf "%s\n" "${failed_packages[@]}" > failed-packages.txt

      # Create a fresh GitHub app token to authenticate PR pushes, in case
      # the previous token expired already (at the time of writing, tokens
      # are valid for 1 hour)
      - name: Create GitHub app token
        uses: actions/create-github-app-token@v2
        id: app-token-2
        with:
          app-id: ${{ vars.LIVE_UPDATE_APP_ID }}
          private-key: ${{ secrets.LIVE_UPDATE_PRIVATE_KEY }}

      - name: Configure git credentials
        run: git remote set-url origin "$auth_url"
        env:
          auth_url: https://x-access-token:${{ steps.app-token-2.outputs.token }}@github.com/${{ github.repository }}.git

      - name: Push branches
        run: |
          git for-each-ref --format='%(refname:short)' refs/heads/live-update | while read branch; do
            echo "Creating PR for $branch"

            package_name=$(basename "$branch")
            pr_title="[${package_name}] (Live update)"
            pr_body=$(echo -e "Automatic update for ${package_name}\n\nGenerated by workflow [${run_label}](${run_url})")

            if git push origin "$branch"; then
              gh pr create --head "$branch" --title "$pr_title" --body "$pr_body" --label "live update" || gh pr comment "$branch" --body "$pr_body"
            else
              echo "::error::Failed to push $branch"
              echo "Failed to push branch $branch" >> failed-packages.txt
            fi
          done
        env:
          run_label: "${{ github.workflow }} #${{ github.run_number}}"
          run_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GH_TOKEN: ${{ steps.app-token-2.outputs.token }}

      - name: Check for failed packages
        run: |
          if [ -n "$(cat failed-packages.txt)" ]; then
            echo "The following package live updates failed:"
            cat failed-packages.txt
            exit 1
          fi
